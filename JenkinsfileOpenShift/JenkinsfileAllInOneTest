pipeline {
    agent any
    stages {
        stage('Clear jaeger deployments') { 
            steps { 
                sh 'oc get all'
                sh 'oc delete all,template,daemonset -l jaeger-infra'
                sh 'oc get all'
            }
        }
        stage('Deploy') { 
            steps { 
                sh 'oc get all'
                sh 'oc process -f https://raw.githubusercontent.com/jaegertracing/jaeger-openshift/master/all-in-one/jaeger-all-in-one-template.yml | oc create -f -'
                sh 'oc get all'
            }
        }
        stage('Verify deployment'){
            steps {
                sh 'oc get dc'
                openshiftVerifyDeployment apiURL: '', authToken: '', depCfg: 'jaeger', namespace: '', replicaCount: '1', verbose: 'true', verifyReplicaCount: 'true', waitTime: '3', waitUnit: 'min'
            }
        }
        stage('Verify services'){
            steps{
                sh 'oc get services'
                openshiftVerifyService apiURL: '', authToken: '', namespace: '', svcName: 'jaeger-query', verbose: 'true'
            }
        }
        stage('Functional test'){
            steps{
                withEnv(["JAVA_HOME=${ tool 'jdk8' }", "PATH+MAVEN=${tool 'maven-3.5.0'}/bin:${env.JAVA_HOME}/bin"]) {
                    sh '''
                        export JAEGER_QUERY_HOST="jaeger-query.jaeger.svc"
                        export JAEGER_AGENT_HOST="jaeger-agent.jaeger.svc"
                        export JAEGER_PORT_QUERY_HTTP=80
                        export JAEGER_PORT_AGENT_ZIPKIN_THRIFT=5775
                        export JAEGER_PORT_AGENT_COMPACT=6831
                        export JAEGER_PORT_AGENT_BINARY=6832
                        export JAEGER_PORT_ZIPKIN_COLLECTOR=14268
                        rm ./jaeger-java-test -rf
                        git clone https://github.com/Hawkular-QE/jaeger-java-test.git
                        cd jaeger-java-test
                        mvn test
                    '''
                }
            }
        }
        stage('Delete all') {
            steps {
                sh 'oc get all'
                sh 'oc delete all,template,daemonset -l jaeger-infra'
                sh 'oc get all'
            }
        }
    }
}